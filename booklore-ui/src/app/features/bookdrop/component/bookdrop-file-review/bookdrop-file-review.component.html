<div class="main-card">
  <div class="header">
    <div class="header-content">
      <h2>
        Review Bookdrop Files
        <a href="https://booklore-app.github.io/booklore-docs/docs/bookdrop" target="_blank" rel="noopener noreferrer">
          <i
            class="pi pi-external-link external-link-icon"
            pTooltip="View documentation"
            tooltipPosition="top"></i>
        </a>
      </h2>
      <p>
        These files were uploaded to the
        <strong>Bookdrop Folder</strong>.
        Review their fetched metadata, assign a library and subpath, and finalize where they belong in your collection.
      </p>
    </div>

    <div class="header-actions">
      <p-button
        label="Rescan"
        size="small"
        icon="pi pi-refresh"
        severity="primary"
        outlined
        (click)="rescanBookdrop()"
        pTooltip="Manually trigger a rescan of the Bookdrop folder"
        tooltipPosition="top">
      </p-button>
    </div>
  </div>
  <div class="card-body">
  @if (loading) {

    <div class="loading-overlay">
      <div class="loading-content">
        <p-progressSpinner strokeWidth="4"/>
        <span>Loading Bookdrop files. Please wait...</span>
      </div>
    </div>

  } @else {

    <div class="controls-section">
      @if (saving) {
        <div class="saving-overlay">
          <p-progressSpinner strokeWidth="4"/>
          <div class="saving-message">
          <span>
            Organizing and moving files to their designated libraries. Please wait...
          </span>
          </div>
        </div>
      }

      @if (bookdropFileUis.length !== 0) {
        <div class="controls-row">
          <div class="action-buttons">
            <p-inputgroup class="importmetadata" [ngClass]="!hasSelectedFiles ? 'disabled' : ''">
              <p-button
                size="small"
                outlined
                severity="info"
                label="Import&nbsp;Metadata"
                icon="pi pi-copy"
                [disabled]="!hasSelectedFiles"
                (click)="copyMetadata()"
                pTooltip="Import fetched metadata for selected files"
                tooltipPosition="top">
              </p-button>
              <p-inputgroup-addon pTooltip="Include book covers when importing fetched metadata" tooltipPosition="top">
                <p-checkbox
                  inputId="includecovers"
                  [disabled]="!hasSelectedFiles"
                  [binary]="true"
                  [(ngModel)]="includeCoversOnCopy">
                </p-checkbox>
                <label for="includecovers"><i class="pi pi-image pl-2"></i></label>
              </p-inputgroup-addon>
            </p-inputgroup>

            <p-button
              size="small"
              class="bulkedit"
              outlined
              severity="help"
              label="Bulk&nbsp;Edit"
              icon="pi pi-pencil"
              [disabled]="!hasSelectedFiles"
              (click)="openBulkEditDialog()"
              pTooltip="Edit metadata fields in bulk for selected files"
              tooltipPosition="top">
            </p-button>

            <p-button
              size="small"
              class="extractpattern"
              outlined
              severity="warn"
              label="Extract&nbsp;Pattern"
              icon="pi pi-sliders-h"
              [disabled]="!hasSelectedFiles"
              (click)="openPatternExtractDialog()"
              pTooltip="Extract metadata from selected filenames using a pattern"
              tooltipPosition="top">
            </p-button>
          </div>
          
          <div class="default-controls">
            <i class="pi pi-book" 
              pTooltip="Specify library and subpath for selected files" 
              tooltipPosition="left"></i>

            <p-select
              size="small"
              [options]="libraryOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Library"
              appendTo="body"
              [(ngModel)]="defaultLibraryId">
            </p-select>

            <p-select
              size="small"
              [options]="selectedLibraryPaths"
              optionLabel="label"
              optionValue="value"
              placeholder="Subpath"
              appendTo="body"
              [(ngModel)]="defaultPathId">
            </p-select>

            <p-button
              size="small"
              icon="pi pi-check"
              severity="info"
              [disabled]="!canApplyDefaults"
              (click)="applyLibraryDefaults()"
              pTooltip="Apply library and subpath to selected files"
              tooltipPosition="top">
            </p-button>
          </div>
        </div>
      }
    </div>

    <div class="content-area">
      @if (bookdropFileUis.length === 0) {
        <div class="empty-state">
          No bookdrop files to review.
        </div>
      } @else {
        @for (file of bookdropFileUis; track file) {

          <div class="file-item">
            <div class="file-row">
              <p-checkbox
                [binary]="true"
                [(ngModel)]="file.selected"
                (ngModelChange)="toggleFileSelection(file.file.id, $event)">
              </p-checkbox>

              @if (file.metadataForm.get('thumbnailUrl')?.value) {
                <img
                  [src]="file.metadataForm.get('thumbnailUrl')?.value"
                  alt="Cover"
                  title="Original cover"
                  class="cover-image"
                  (click)="file.showDetails = !file.showDetails"/>
              } @else {
                <div title="No cover found" class="cover-image text-sm">?</div>
              }

              @if (file.file.fetchedMetadata?.thumbnailUrl) {
                <img
                  [src]="file.file.fetchedMetadata?.thumbnailUrl"
                  alt="Fetched Cover"
                  title="Fetched cover"
                  class="cover-image"
                  (click)="file.showDetails = !file.showDetails"/>
              } @else {
                <div title="No cover fetched" class="cover-image text-sm">?</div>
              }

              <div class="file-name" (click)="file.showDetails = !file.showDetails">
                {{ file.file.fileName }}
              </div>

              <div class="file-library">
                <i 
                  class="pi metadata-status"
                  [ngClass]="{
                    'pi-check-circle copied': copiedFlags[file.file.id],
                    'pi-check-circle no-metadata': !file.file.fetchedMetadata,
                    'pi-exclamation-triangle not-applied': file.file.fetchedMetadata && !copiedFlags[file.file.id]
                  }"
                  [pTooltip]="copiedFlags[file.file.id]
                    ? 'Fetched metadata has been applied.'
                    : (!file.file.fetchedMetadata || !file.file.fetchedMetadata.title)
                      ? 'No fetched metadata available. Original metadata will be used.'
                      : 'Fetched metadata hasnâ€™t been applied yet. Open metadata picker to review.'"
                  tooltipPosition="top">
                </i>

                <p-select
                  size="small"
                  [options]="libraryOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Library"
                  class="library-select"
                  appendTo="body"
                  [(ngModel)]="file.selectedLibraryId"
                  (onChange)="onLibraryChange(file)">
                </p-select>

                <p-select
                  size="small"
                  [options]="file.availablePaths"
                  optionLabel="name"
                  optionValue="id"
                  placeholder="Subpath"
                  class="path-select"
                  appendTo="body"
                  [(ngModel)]="file.selectedPathId">
                </p-select>

                <p-button
                  size="small"
                  [variant]="file.file.fetchedMetadata?.title ? undefined : 'outlined'"
                  [icon]="file.showDetails ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                  (click)="file.showDetails = !file.showDetails"
                  [pTooltip]="file.showDetails
                    ? 'Hide metadata'
                    : file.file.fetchedMetadata?.title 
                      ? 'Review and copy fetched metadata'
                      : 'Show file metadata (no fetched metadata)'"
                  tooltipPosition="left">
                </p-button>
              </div>
            </div>

            @if (file.showDetails) {
              <app-bookdrop-file-metadata-picker-component
                class="details-section"
                [originalMetadata]="file.file.originalMetadata"
                [fetchedMetadata]="file.file.fetchedMetadata!"
                [metadataForm]="file.metadataForm"
                [copiedFields]="file.copiedFields"
                [savedFields]="file.savedFields"
                [bookdropFileId]="file.file.id"
                (metadataCopied)="onMetadataCopied(file.file.id, $event)">
              </app-bookdrop-file-metadata-picker-component>
            }
          </div>
        }
      }
    </div>
  }
  </div>

  @if (!loading) {
    <p-divider></p-divider>

    <div class="footer">

      <div class="footer-left">
        @if (bookdropFileUis.length > 0) {
          <p-inputgroup class="selectall">
            <p-inputgroup-addon>
              <label class="text-sm" pTooltip="Number of files selected" tooltipPosition="top">{{ selectedCount }}</label>
            </p-inputgroup-addon>
            <p-button
              label="Select&nbsp;All"
              icon="pi pi-check-square"
              severity="info"
              (click)="selectAll(true)"
              outlined
              pTooltip="Select all files across all pages"
              tooltipPosition="top">
            </p-button>
          </p-inputgroup>

          <p-button
            label="Clear"
            icon="pi pi-times-circle"
            severity="warn"
            [disabled]="!hasSelectedFiles"
            (click)="selectAll(false)"
            outlined
            pTooltip="Deselect all files across all pages"
            tooltipPosition="top">
          </p-button>
        } @else {
          <div class="spacer"></div>
        }
      </div>

      @if (totalRecords > pageSize) {
        <div class="footer-center">
          <p-paginator
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [first]="currentPage * pageSize"
            (onPageChange)="loadPage($event.page ?? 0)"
            [showJumpToPageDropdown]="true"
            [showPageLinks]="false"
            [showFirstLastIcon]="false"
            currentPageReportTemplate="Page {currentPage} of {totalPages}">
          </p-paginator>
        </div>
      }

      <div class="footer-right">
        <p-button
          label="Reset"
          icon="pi pi-refresh"
          severity="warn"
          [disabled]="!hasSelectedFiles"
          outlined
          (click)="confirmReset()"
          pTooltip="Discard all changes made to metadata of selected files"
          tooltipPosition="top">
        </p-button>
        <p-button
          label="Delete"
          icon="pi pi-times"
          severity="danger"
          [disabled]="!hasSelectedFiles"
          outlined
          (click)="confirmDelete()"
          pTooltip="Permanently delete selected Bookdrop files and discard any changes"
          tooltipPosition="top">
        </p-button>
        <p-button
          label="Finalize"
          [icon]="saving ? 'pi pi-spin pi-spinner' : 'pi pi-save'"
          severity="success"
          outlined
          [disabled]="!canFinalize || saving"
          (click)="confirmFinalize()"
          pTooltip="Move selected files into the chosen library and subpath"
          tooltipPosition="top">
        </p-button>
      </div>

    </div>
  }
</div>
